#!/opt/perl/bin/perl
use strict;
use warnings;
use feature ':5.10';
use Storable qw( retrieve store );
use File::Basename qw( dirname );
use lib dirname(__FILE__);
use TM qw( size );

my $in_edge  = "$ARGV[0].fulledge";
my $out_edge = "$ARGV[0].edge";

say "Read $in_edge (@{[ size( -s $in_edge ) ]})";
my $edge = retrieve( $in_edge );
my %new = ( 'root' => {} );
my %seen;

t( 'root' );

store( \%new, $out_edge );
say "Wrote $out_edge (@{[ size( -s $out_edge ) ]})";

sub t {
    my ( $parent ) =@_;

    my $children = $edge->{$parent};
    return if ! $children;

    my $new_children = $new{$parent} ||= {};

    for my $child ( keys %$children ) {
        if (exists $seen{$child}) {
            say "Pruning $parent -> $child";
            next;
        }
        $seen{$child} = undef;

        $new_children->{$child} = undef;
        t( $child );
    }
}
